{% extends "base.html" %}

{% block title %}Generation History - Gen AI Platform{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1><i class="fas fa-history"></i> Generation History</h1>
        <p>View your recent AI generations</p>
    </div>

    <div class="filter-bar">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="image">Images</button>
        <button class="filter-btn" data-filter="video">Videos</button>
        <button class="filter-btn" data-filter="music">Music</button>
    </div>

    <div class="history-grid" id="history-grid">
        {% if generations %}
            {% for gen in generations %}
            <div class="history-card" data-type="{{ gen.type }}">
                <div class="history-card-header">
                    <span class="type-badge type-{{ gen.type }}">
                        {% if gen.type == 'image' %}
                            <i class="fas fa-image"></i> Image
                        {% elif gen.type == 'video' %}
                            <i class="fas fa-video"></i> Video
                        {% elif gen.type == 'music' %}
                            <i class="fas fa-music"></i> Music
                        {% endif %}
                    </span>
                    <span class="date">{{ gen.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                
                <div class="history-card-body">
                    <p class="prompt">{{ gen.prompt[:100] }}{% if gen.prompt|length > 100 %}...{% endif %}</p>
                    
                    <div class="status-badge status-{{ gen.status }}">
                        {% if gen.status == 'completed' %}
                            <i class="fas fa-check-circle"></i> Completed
                        {% elif gen.status == 'processing' %}
                            <i class="fas fa-spinner fa-spin"></i> Processing
                        {% elif gen.status == 'failed' %}
                            <i class="fas fa-times-circle"></i> Failed
                        {% endif %}
                    </div>
                </div>
                
                <div class="history-card-footer">
                    {% if gen.status == 'completed' %}
                        <a href="/{{ gen.output_path }}" class="btn btn-small btn-primary" download>
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% endif %}
                    <button class="btn btn-small btn-secondary" onclick="viewDetails('{{ gen.id }}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>No generations yet</h3>
                <p>Start creating amazing content with AI!</p>
                <div class="empty-state-actions">
                    <a href="{{ url_for('image_generator') }}" class="btn btn-primary">Generate Images</a>
                    <a href="{{ url_for('video_generator') }}" class="btn btn-secondary">Create Videos</a>
                    <a href="{{ url_for('music_generator') }}" class="btn btn-accent">Compose Music</a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Details Modal -->
<div id="details-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Generation Details</h2>
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Details will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filter functionality
const filterButtons = document.querySelectorAll('.filter-btn');
const historyCards = document.querySelectorAll('.history-card');

filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        // Update active state
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const filter = btn.dataset.filter;
        
        // Filter cards
        historyCards.forEach(card => {
            if (filter === 'all' || card.dataset.type === filter) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
});

// View details
async function viewDetails(generationId) {
    try {
        const response = await fetch(`/api/generations/${generationId}`);
        const data = await response.json();
        
        const modalBody = document.getElementById('modal-body');
        const params = JSON.parse(data.parameters);
        
        let paramsHtml = '';
        for (const [key, value] of Object.entries(params)) {
            paramsHtml += `<p><strong>${key}:</strong> ${JSON.stringify(value)}</p>`;
        }
        
        modalBody.innerHTML = `
            <div class="detail-section">
                <h3>Type</h3>
                <p class="type-badge type-${data.type}">${data.type}</p>
            </div>
            <div class="detail-section">
                <h3>Prompt</h3>
                <p>${data.prompt}</p>
            </div>
            <div class="detail-section">
                <h3>Parameters</h3>
                ${paramsHtml}
            </div>
            <div class="detail-section">
                <h3>Status</h3>
                <p class="status-badge status-${data.status}">${data.status}</p>
            </div>
            <div class="detail-section">
                <h3>Created</h3>
                <p>${new Date(data.created_at).toLocaleString()}</p>
            </div>
        `;
        
        document.getElementById('details-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading details:', error);
    }
}

function closeModal() {
    document.getElementById('details-modal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('details-modal').addEventListener('click', (e) => {
    if (e.target.id === 'details-modal') {
        closeModal();
    }
});
</script>
{% endblock %}
