{% extends "base.html" %}

{% block title %}Music Generator - Gen AI Platform{% endblock %}

{% block content %}
<div class="generator-container">
    <div class="generator-header">
        <h1><i class="fas fa-music"></i> AI Music Generator</h1>
        <p>Create original music compositions using Google's Lyria</p>
    </div>

    <div class="generator-main">
        <div class="generator-form">
            <form id="music-form">
                <div class="form-group">
                    <label>Music Prompts</label>
                    <div id="prompts-container">
                        <div class="prompt-item">
                            <input 
                                type="text" 
                                class="prompt-text" 
                                placeholder="e.g., Piano, Jazz, Upbeat"
                                required
                            >
                            <input 
                                type="number" 
                                class="prompt-weight" 
                                min="0" 
                                max="2" 
                                step="0.1" 
                                value="1.0"
                                placeholder="Weight"
                            >
                            <button type="button" class="btn-icon remove-prompt" disabled>
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" id="add-prompt-btn">
                        <i class="fas fa-plus"></i> Add Prompt
                    </button>
                    <small class="form-hint">Add multiple prompts with different weights to blend musical styles</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bpm">BPM (Beats Per Minute)</label>
                        <input 
                            type="range" 
                            id="bpm" 
                            name="bpm" 
                            min="60" 
                            max="180" 
                            value="120"
                        >
                        <span class="range-value" id="bpm-value">120</span>
                    </div>

                    <div class="form-group">
                        <label for="temperature">Temperature (Creativity)</label>
                        <input 
                            type="range" 
                            id="temperature" 
                            name="temperature" 
                            min="0" 
                            max="2" 
                            step="0.1" 
                            value="1.0"
                        >
                        <span class="range-value" id="temperature-value">1.0</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="duration">Duration (seconds)</label>
                    <input 
                        type="range" 
                        id="duration" 
                        name="duration" 
                        min="10" 
                        max="120" 
                        step="5" 
                        value="30"
                    >
                    <span class="range-value" id="duration-value">30s</span>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large" id="generate-btn">
                        <i class="fas fa-play"></i> Generate Music
                    </button>
                    <button type="button" class="btn btn-secondary" id="clear-btn">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                </div>
            </form>

            <div class="info-box">
                <i class="fas fa-lightbulb"></i>
                <p><strong>Tips:</strong> Higher temperature = more creative. Use multiple prompts to blend styles.</p>
            </div>
        </div>

        <div class="generator-output">
            <div class="output-header">
                <h3>Generated Music</h3>
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Composing your music... Please wait.</p>
                </div>
            </div>

            <div id="output-area" class="output-area">
                <div class="placeholder">
                    <i class="fas fa-headphones"></i>
                    <p>Your generated music will appear here</p>
                </div>
            </div>

            <div id="error-message" class="error-message hidden"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const musicForm = document.getElementById('music-form');
const generateBtn = document.getElementById('generate-btn');
const clearBtn = document.getElementById('clear-btn');
const outputArea = document.getElementById('output-area');
const loading = document.getElementById('loading');
const errorMessage = document.getElementById('error-message');
const addPromptBtn = document.getElementById('add-prompt-btn');
const promptsContainer = document.getElementById('prompts-container');

// Update slider values
document.getElementById('bpm').addEventListener('input', (e) => {
    document.getElementById('bpm-value').textContent = e.target.value;
});

document.getElementById('temperature').addEventListener('input', (e) => {
    document.getElementById('temperature-value').textContent = e.target.value;
});

document.getElementById('duration').addEventListener('input', (e) => {
    document.getElementById('duration-value').textContent = e.target.value + 's';
});

// Add new prompt
addPromptBtn.addEventListener('click', () => {
    const promptItem = document.createElement('div');
    promptItem.className = 'prompt-item';
    promptItem.innerHTML = `
        <input type="text" class="prompt-text" placeholder="e.g., Piano, Jazz, Upbeat" required>
        <input type="number" class="prompt-weight" min="0" max="2" step="0.1" value="1.0" placeholder="Weight">
        <button type="button" class="btn-icon remove-prompt">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    promptItem.querySelector('.remove-prompt').addEventListener('click', () => {
        promptItem.remove();
        updateRemoveButtons();
    });
    
    promptsContainer.appendChild(promptItem);
    updateRemoveButtons();
});

function updateRemoveButtons() {
    const removeButtons = document.querySelectorAll('.remove-prompt');
    removeButtons.forEach((btn, index) => {
        btn.disabled = removeButtons.length === 1;
    });
}

// Clear form
clearBtn.addEventListener('click', () => {
    musicForm.reset();
    promptsContainer.innerHTML = `
        <div class="prompt-item">
            <input type="text" class="prompt-text" placeholder="e.g., Piano, Jazz, Upbeat" required>
            <input type="number" class="prompt-weight" min="0" max="2" step="0.1" value="1.0" placeholder="Weight">
            <button type="button" class="btn-icon remove-prompt" disabled>
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.getElementById('bpm-value').textContent = '120';
    document.getElementById('temperature-value').textContent = '1.0';
    document.getElementById('duration-value').textContent = '30s';
    outputArea.innerHTML = '<div class="placeholder"><i class="fas fa-headphones"></i><p>Your generated music will appear here</p></div>';
    errorMessage.classList.add('hidden');
});

// Handle form submission
musicForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Collect prompts
    const prompts = [];
    document.querySelectorAll('.prompt-item').forEach(item => {
        const text = item.querySelector('.prompt-text').value;
        const weight = parseFloat(item.querySelector('.prompt-weight').value);
        if (text) {
            prompts.push({ text, weight });
        }
    });
    
    const bpm = parseInt(document.getElementById('bpm').value);
    const temperature = parseFloat(document.getElementById('temperature').value);
    const duration = parseInt(document.getElementById('duration').value);
    
    // Show loading
    loading.classList.remove('hidden');
    errorMessage.classList.add('hidden');
    generateBtn.disabled = true;
    outputArea.innerHTML = '';
    
    try {
        const response = await fetch('/api/generate-music', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompts: prompts,
                bpm: bpm,
                temperature: temperature,
                duration: duration
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayAudio(data.audio_path, prompts);
            showSuccess(data.message);
        } else {
            showError(data.error || 'Failed to generate music');
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    } finally {
        loading.classList.add('hidden');
        generateBtn.disabled = false;
    }
});

function displayAudio(audioPath, prompts) {
    const promptsText = prompts.map(p => `${p.text} (${p.weight})`).join(', ');
    
    outputArea.innerHTML = `
        <div class="audio-card">
            <div class="audio-info">
                <i class="fas fa-music"></i>
                <div>
                    <h4>Generated Music Track</h4>
                    <p class="audio-prompts">${promptsText}</p>
                </div>
            </div>
            <audio controls>
                <source src="/${audioPath}" type="audio/wav">
                Your browser does not support the audio tag.
            </audio>
            <div class="audio-actions">
                <button class="btn btn-primary" onclick="downloadAudio('/${audioPath}', 'generated_music.wav')">
                    <i class="fas fa-download"></i> Download Audio
                </button>
                <button class="btn btn-secondary" onclick="shareAudio('/${audioPath}')">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
        </div>
    `;
}

function downloadAudio(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function shareAudio(url) {
    if (navigator.share) {
        navigator.share({
            title: 'Generated Music',
            url: url
        });
    } else {
        navigator.clipboard.writeText(window.location.origin + url);
        showSuccess('Link copied to clipboard!');
    }
}

function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
}

function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.textContent = message;
    document.querySelector('.generator-container').prepend(successDiv);
    
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
